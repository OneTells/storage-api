http:
  routers:
    backend:
      rule: "Host(`api.ya.ru`)"
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt
      middlewares:
        - compress-middleware
        - retry-middleware
      service: backend

    www-redirect:
      rule: "Host(`www.api.ya.ru`)"
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt
      middlewares:
        - redirect-to-non-www
      service: backend

  middlewares:
    compress-middleware:
      compress: { }

    retry-middleware:
      retry:
        attempts: 10
        initialInterval: "1s"

    redirect-to-non-www:
      redirectRegex:
        regex: "^https://www\\.(.*)"
        replacement: "https://${1}"
        permanent: true

  services:
    backend:
      loadBalancer:
        servers:
          - url: "http://backend:8000"
